--CTE for calculating key metrics by account
WITH account_metrics AS
(SELECT
 s.date,
 sp.country,
 a.send_interval,
 CASE WHEN a.is_verified = 1 THEN 'verified' ELSE 'not verified' END AS is_verified,
 CASE WHEN a.is_unsubscribed = 1 THEN 'unsubscribed' ELSE 'subscribed' END AS is_unsubscribed,
 COUNT(DISTINCT id) AS account_cnt,
 0 AS sent_msg,
 0 AS open_msg,
 0 AS visit_msg
FROM
 `DA.account` a
JOIN
 `DA.account_session` acs
ON
 a.id = acs.account_id
JOIN
 `DA.session` s
ON
 acs.ga_session_id = s.ga_session_id
JOIN
 `DA.session_params` sp
ON
 acs.ga_session_id = sp.ga_session_id
GROUP BY
 s.date,
 sp.country,
 a.send_interval,
 is_verified,
 is_unsubscribed),

--CTE for calculating key metrics for emails
email_metrics AS
(SELECT
 DATE_ADD(s.date, INTERVAL sent_date DAY) AS date,
 sp.country,
 a.send_interval,
 CASE WHEN a.is_verified = 1 THEN 'verified' ELSE 'not verified' END AS is_verified,
 CASE WHEN a.is_unsubscribed = 1 THEN 'unsubscribed' ELSE 'subscribed' END AS is_unsubscribed,
 0 AS account_cnt,
 COUNT(DISTINCT es.id_message) AS sent_msg,
 COUNT(DISTINCT eo.id_message) AS open_msg,
 COUNT(DISTINCT ev.id_message) AS visit_msg
FROM
 `DA.email_sent` es
LEFT JOIN
 `DA.email_open` eo
ON
 es.id_message = eo.id_message
LEFT JOIN
 `DA.email_visit` ev
ON
 es.id_message = ev.id_message
JOIN
 `DA.account` a
ON
 es.id_account = a.id
JOIN
 `DA.account_session` acs
ON
 a.id = acs.account_id
JOIN
 `DA.session` s
ON
 acs.ga_session_id = s.ga_session_id
JOIN
 `DA.session_params` sp
ON
 acs.ga_session_id = sp.ga_session_id
GROUP BY
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed),

--CTE for data aggregation
union_information AS
(SELECT
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed,
 account_cnt,
 sent_msg,
 open_msg,
 visit_msg
FROM `account_metrics`
UNION ALL
SELECT
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed,
 account_cnt,
 sent_msg,
 open_msg,
 visit_msg
FROM email_metrics),

--CTE for cleaning NULL values
aggregated_data AS
(SELECT
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed,
 SUM(account_cnt) AS account_cnt,
 SUM(sent_msg) AS sent_msg,
 SUM(open_msg) AS open_msg,
 SUM(visit_msg) AS visit_msg
FROM
 `union_information`
GROUP BY
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed),

--CTE for calculating total amounts
total_data AS
(SELECT
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed,
 account_cnt,
 sent_msg,
 open_msg,
 visit_msg,
 SUM(account_cnt) OVER(PARTITION BY country) AS total_country_account_cnt,
 SUM(sent_msg) OVER(PARTITION BY country) AS total_country_sent_cnt,
FROM
 `aggregated_data`),

--CTE for data ranking
ranked_data AS
(SELECT
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed,
 account_cnt,
 sent_msg,
 open_msg,
 visit_msg,
 total_country_account_cnt,
 total_country_sent_cnt,
 DENSE_RANK() OVER(ORDER BY total_country_account_cnt DESC) AS rank_total_country_account_cnt,
 DENSE_RANK() OVER(ORDER BY total_country_sent_cnt DESC) AS rank_total_country_sent_cnt
FROM
 `total_data`)
SELECT
 date,
 country,
 send_interval,
 is_verified,
 is_unsubscribed,
 account_cnt,
 sent_msg,
 open_msg,
 visit_msg,
 total_country_account_cnt,
 total_country_sent_cnt,
 rank_total_country_account_cnt,
 rank_total_country_sent_cnt
FROM
 `ranked_data`
WHERE
 rank_total_country_account_cnt <= 10 OR rank_total_country_sent_cnt <= 10;
